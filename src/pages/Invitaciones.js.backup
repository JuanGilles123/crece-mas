import React, { useEffect, useState } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { motion } from 'framer-motion';
import { 
  Mail, 
  Building2, 
  CheckCircle, 
  XCircle, 
  Clock,
  Shield,
  ArrowRight,
  AlertCircle,
  LogIn,
  UserPlus
} from 'lucide-react';
import { supabase } from '../supabaseClient';
import { useAuth } from '../context/AuthContext';
import {
  useMyInvitations,
  useAcceptInvitation,
  useRejectInvitation
} from '../hooks/useTeam';
import './Invitaciones.css';

const ROLES = {
  admin: {
    label: 'Administrador',
    icon: <Shield size={20} />,
    color: '#3B82F6',
    description: 'Gestión completa excepto facturación',
    permissions: [
      'Ver dashboard completo',
      'Gestionar inventario',
      'Realizar ventas',
      'Ver reportes',
      'Gestionar equipo'
    ]
  },
  inventory_manager: {
    label: 'Encargado de Inventario',
    icon: <Shield size={20} />,
    color: '#10B981',
    description: 'Gestión de inventario y ventas',
    permissions: [
      'Ver dashboard',
      'Gestionar inventario completo',
      'Realizar ventas',
      'Ver productos'
    ]
  },
  cashier: {
    label: 'Cajero',
    icon: <Shield size={20} />,
    color: '#8B5CF6',
    description: 'Solo módulo de caja',
    permissions: [
      'Acceso al módulo de caja',
      'Realizar ventas',
      'Ver inventario (solo lectura)',
      'Generar recibos'
    ]
  },
  viewer: {
    label: 'Visualizador',
    icon: <Shield size={20} />,
    color: '#6B7280',
    description: 'Solo lectura de reportes',
    permissions: [
      'Ver dashboard',
      'Ver reportes de ventas',
      'Solo lectura (sin edición)'
    ]
  }
};

const InvitationCard = ({ invitation, onAccept, onReject, loading }) => {
  const roleInfo = ROLES[invitation.role] || ROLES.viewer;
  const isExpired = new Date(invitation.expires_at) < new Date();

  return (
    <motion.div 
      className={`invitation-detail-card ${isExpired ? 'expired' : ''}`}
      initial={{ opacity: 0, scale: 0.95 }}
      animate={{ opacity: 1, scale: 1 }}
      transition={{ duration: 0.3 }}
    >
      {isExpired && (
        <div className="expired-banner">
          <AlertCircle size={20} />
          Esta invitación ha expirado
        </div>
      )}

      <div className="invitation-header">
        <div className="organization-info">
          <div className="organization-icon">
            <Building2 size={32} />
          </div>
          <div>
            <h2>{invitation.organizations?.name || 'Organización'}</h2>
            <p className="business-type">
              {invitation.organizations?.business_type === 'food' && '🍔 Comida rápida'}
              {invitation.organizations?.business_type === 'clothing' && '👔 Ropa'}
              {invitation.organizations?.business_type === 'retail' && '🏪 Retail'}
              {invitation.organizations?.business_type === 'other' && '📦 Otro'}
            </p>
          </div>
        </div>

        <div className="role-info">
          <div className="role-badge-large" style={{ backgroundColor: roleInfo.color }}>
            {roleInfo.icon}
            {roleInfo.label}
          </div>
          <p className="role-description">{roleInfo.description}</p>
        </div>
      </div>

      {invitation.message && (
        <div className="invitation-message">
          <Mail size={18} />
          <p>{invitation.message}</p>
        </div>
      )}

      <div className="permissions-section">
        <h3>Permisos que tendrás:</h3>
        <ul className="permissions-list">
          {roleInfo.permissions.map((permission, index) => (
            <li key={index}>
              <CheckCircle size={16} />
              {permission}
            </li>
          ))}
        </ul>
      </div>

      <div className="invitation-meta">
        <div className="meta-item">
          <Clock size={16} />
          <span>
            {isExpired 
              ? 'Expirada' 
              : `Expira: ${new Date(invitation.expires_at).toLocaleDateString('es-CO', {
                  day: 'numeric',
                  month: 'long',
                  year: 'numeric'
                })}`
            }
          </span>
        </div>
        <div className="meta-item">
          <Mail size={16} />
          <span>{invitation.email}</span>
        </div>
      </div>

      {!isExpired && (
        <div className="invitation-actions">
          <button 
            className="btn btn-reject"
            onClick={() => onReject(invitation.id)}
            disabled={loading}
          >
            <XCircle size={20} />
            Rechazar
          </button>
          <button 
            className="btn btn-accept"
            onClick={() => onAccept(invitation.token)}
            disabled={loading}
          >
            <CheckCircle size={20} />
            {loading ? 'Aceptando...' : 'Aceptar Invitación'}
            <ArrowRight size={20} />
          </button>
        </div>
      )}
    </motion.div>
  );
};

const Invitaciones = () => {
  const { user, loading: authLoading } = useAuth();
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();
  const token = searchParams.get('token');
  
  // Estado para invitación pública (sin autenticación)
  const [publicInvitation, setPublicInvitation] = useState(null);
  const [loadingPublic, setLoadingPublic] = useState(false);
  const [error, setError] = useState(null);
  
  // Para usuarios autenticados
  const { data: invitations = [], isLoading } = useMyInvitations(user?.email);
  const acceptInvitation = useAcceptInvitation();
  const rejectInvitation = useRejectInvitation();
  
  const [selectedInvitation, setSelectedInvitation] = useState(null);

  // Cargar invitación pública si hay token y NO hay usuario autenticado
  useEffect(() => {
    const loadPublicInvitation = async () => {
      if (!token || user) return; // Si no hay token o ya está autenticado, salir
      
      setLoadingPublic(true);
      setError(null);
      
      try {
        const { data, error: fetchError } = await supabase
          .from('team_invitations')
          .select(`
            *,
            organizations (
              name,
              business_type
            )
          `)
          .eq('token', token)
          .eq('status', 'pending')
          .single();
        
        if (fetchError) {
          console.error('Error fetching invitation:', fetchError);
          setError('Invitación no encontrada o ya fue usada');
          return;
        }
        
        // Verificar si expiró
        if (new Date(data.expires_at) < new Date()) {
          setError('Esta invitación ha expirado');
          return;
        }
        
        setPublicInvitation(data);
      } catch (err) {
        console.error('Error loading invitation:', err);
        setError('Error al cargar la invitación');
      } finally {
        setLoadingPublic(false);
      }
    };
    
    loadPublicInvitation();
  }, [token, user]);

  // Si hay un token en la URL y el usuario está autenticado, buscar esa invitación
  useEffect(() => {
    if (token && user && invitations.length > 0) {
      const invitation = invitations.find(inv => inv.token === token);
      if (invitation) {
        setSelectedInvitation(invitation);
      }
    }
  }, [token, invitations, user]);
      }
    } else if (invitations.length === 1) {
      setSelectedInvitation(invitations[0]);
    }
  }, [token, invitations]);

  const handleAccept = async (invitationToken) => {
    try {
      await acceptInvitation.mutateAsync(invitationToken);
      // Redirigir al dashboard después de aceptar
      setTimeout(() => {
        navigate('/dashboard');
      }, 1500);
    } catch (error) {
      console.error('Error accepting invitation:', error);
    }
  };

  const handleReject = async (invitationId) => {
    if (window.confirm('¿Estás seguro de rechazar esta invitación?')) {
      try {
        await rejectInvitation.mutateAsync(invitationId);
        navigate('/dashboard');
      } catch (error) {
        console.error('Error rejecting invitation:', error);
      }
    }
  };

  // Requiere autenticación
  if (authLoading) {
    return (
      <div className="invitaciones-container">
        <div className="loading-state">
          <div className="spinner"></div>
          <p>Cargando...</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="invitaciones-container">
        <div className="auth-required">
          <AlertCircle size={48} />
          <h2>Inicia sesión para ver tus invitaciones</h2>
          <p>Necesitas estar autenticado para aceptar invitaciones de equipo.</p>
          <button 
            className="btn btn-primary"
            onClick={() => navigate('/login')}
          >
            Iniciar Sesión
          </button>
        </div>
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="invitaciones-container">
        <div className="loading-state">
          <div className="spinner"></div>
          <p>Cargando invitaciones...</p>
        </div>
      </div>
    );
  }

  if (invitations.length === 0) {
    return (
      <div className="invitaciones-container">
        <div className="empty-invitations">
          <Mail size={64} />
          <h2>No tienes invitaciones pendientes</h2>
          <p>Cuando alguien te invite a un equipo, las invitaciones aparecerán aquí.</p>
          <button 
            className="btn btn-secondary"
            onClick={() => navigate('/dashboard')}
          >
            Ir al Dashboard
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="invitaciones-container">
      <div className="invitaciones-header">
        <h1>
          <Mail size={32} />
          Invitaciones de Equipo
        </h1>
        <p>Tienes {invitations.length} invitación{invitations.length !== 1 ? 'es' : ''} pendiente{invitations.length !== 1 ? 's' : ''}</p>
      </div>

      <div className="invitations-content">
        {selectedInvitation ? (
          <InvitationCard
            invitation={selectedInvitation}
            onAccept={handleAccept}
            onReject={handleReject}
            loading={acceptInvitation.isLoading || rejectInvitation.isLoading}
          />
        ) : (
          <div className="invitations-list-view">
            <h3>Selecciona una invitación:</h3>
            {invitations.map(invitation => (
              <motion.div
                key={invitation.id}
                className="invitation-list-item"
                onClick={() => setSelectedInvitation(invitation)}
                whileHover={{ scale: 1.02 }}
                whileTap={{ scale: 0.98 }}
              >
                <div className="list-item-icon">
                  <Building2 size={24} />
                </div>
                <div className="list-item-info">
                  <h4>{invitation.organizations?.name}</h4>
                  <p>Rol: {ROLES[invitation.role]?.label}</p>
                </div>
                <ArrowRight size={20} />
              </motion.div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default Invitaciones;
